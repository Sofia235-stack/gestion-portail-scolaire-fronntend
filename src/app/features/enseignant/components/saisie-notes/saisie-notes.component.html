<div class="notes-container">
  <h1 class="page-title">Saisie des notes</h1>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="!loading" class="notes-content">
    <!-- Filtres -->
    <mat-card>
      <mat-card-content>
        <div class="filters-container">
          <mat-form-field appearance="outline">
            <mat-label>Classe</mat-label>
            <mat-select [(ngModel)]="selectedClasseId" (selectionChange)="onClasseChange()" required>
              <mat-option *ngFor="let classe of classes" [value]="classe.id">
                {{ classe.nom }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Matière</mat-label>
            <mat-select [(ngModel)]="selectedMatiereId" (selectionChange)="loadNotes()" required>
              <mat-option *ngFor="let matiere of matieres" [value]="matiere.id">
                {{ matiere.nom }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Trimestre</mat-label>
            <mat-select [(ngModel)]="selectedTrimestre" (selectionChange)="loadNotes()" required>
              <mat-option [value]="1">Trimestre 1</mat-option>
              <mat-option [value]="2">Trimestre 2</mat-option>
              <mat-option [value]="3">Trimestre 3</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Formulaire d'ajout de note -->
    <mat-card *ngIf="selectedClasseId && selectedMatiereId && eleves.length > 0">
      <mat-card-header>
        <mat-card-title>Ajouter une note</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="noteForm" (ngSubmit)="onSubmit()" class="form-container">
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Élève</mat-label>
              <mat-select formControlName="eleveId" required>
                <mat-option *ngFor="let eleve of eleves" [value]="eleve.id">
                  {{ eleve.nom }} {{ eleve.prenom }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="noteForm.get('eleveId')?.hasError('required')">
                L'élève est requis
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Note</mat-label>
              <input matInput type="number" formControlName="valeur" min="0" max="20" step="0.5" required>
              <mat-error *ngIf="noteForm.get('valeur')?.hasError('required')">
                La note est requise
              </mat-error>
              <mat-error *ngIf="noteForm.get('valeur')?.hasError('min') || noteForm.get('valeur')?.hasError('max')">
                La note doit être comprise entre 0 et 20
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Coefficient</mat-label>
              <input matInput type="number" formControlName="coefficient" min="1" max="10" required>
              <mat-error *ngIf="noteForm.get('coefficient')?.hasError('required')">
                Le coefficient est requis
              </mat-error>
              <mat-error *ngIf="noteForm.get('coefficient')?.hasError('min') || noteForm.get('coefficient')?.hasError('max')">
                Le coefficient doit être compris entre 1 et 10
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Date</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="date" required>
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error *ngIf="noteForm.get('date')?.hasError('required')">
                La date est requise
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Commentaire</mat-label>
              <textarea matInput formControlName="commentaire" rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="noteForm.invalid">
              Ajouter la note
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Liste des notes -->
    <mat-card *ngIf="selectedClasseId && selectedMatiereId">
      <mat-card-header>
        <mat-card-title>Notes enregistrées</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="mat-table-container">
          <table mat-table [dataSource]="notes" *ngIf="notes.length > 0">
            <!-- Élève Column -->
            <ng-container matColumnDef="eleve">
              <th mat-header-cell *matHeaderCellDef> Élève </th>
              <td mat-cell *matCellDef="let note"> {{note.eleve?.nom}} {{note.eleve?.prenom}} </td>
            </ng-container>

            <!-- Note Column -->
            <ng-container matColumnDef="note">
              <th mat-header-cell *matHeaderCellDef> Note </th>
              <td mat-cell *matCellDef="let note"> {{note.valeur}} / 20 (coef. {{note.coefficient}}) </td>
            </ng-container>

            <!-- Commentaire Column -->
            <ng-container matColumnDef="commentaire">
              <th mat-header-cell *matHeaderCellDef> Commentaire </th>
              <td mat-cell *matCellDef="let note"> {{note.commentaire || '-'}} </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let note">
                <div class="action-buttons">
                  <button mat-icon-button color="warn" (click)="deleteNote(note.id)" matTooltip="Supprimer">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <div *ngIf="notes.length === 0" class="empty-list">
            <p>Aucune note enregistrée pour cette classe, cette matière et ce trimestre.</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>