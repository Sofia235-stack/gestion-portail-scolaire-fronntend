<div class="portail-container">
  <h1 class="page-title">Bienvenue {{ currentUser?.prenom }} {{ currentUser?.nom }}</h1>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="!loading" class="portail-content">
    <!-- Informations personnelles -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Informations personnelles</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Nom</div>
            <div class="info-value">{{ currentUser?.nom }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Prénom</div>
            <div class="info-value">{{ currentUser?.prenom }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Email</div>
            <div class="info-value">{{ currentUser?.email }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Classe</div>
            <div class="info-value">{{ stats.classe?.nom || 'Non assigné' }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Résumé des notes -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Résumé des notes</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stats-grid">
          <div class="stats-card">
            <div class="stats-value">{{ stats.moyenneGenerale?.toFixed(2) || '0.00' }}</div>
            <div class="stats-label">Moyenne générale</div>
          </div>
          <div class="stats-card">
            <div class="stats-value">{{ stats.totalNotes || 0 }}</div>
            <div class="stats-label">Notes</div>
          </div>
          <div class="stats-card">
            <div class="stats-value">{{ stats.meilleureNote?.toFixed(2) || '0.00' }}</div>
            <div class="stats-label">Meilleure note</div>
          </div>
        </div>

        <h3>Moyennes par trimestre</h3>
        <div class="trimestres-grid">
          <div class="trimestre-card" *ngFor="let trimestre of stats.moyennesParTrimestre">
            <div class="trimestre-title">Trimestre {{ trimestre.trimestre }}</div>
            <div class="trimestre-moyenne">{{ trimestre.moyenne?.toFixed(2) || '0.00' }}</div>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button routerLink="/eleve-parent/notes">Voir toutes les notes</button>
        <button mat-button routerLink="/eleve-parent/bulletins">Voir les bulletins</button>
      </mat-card-actions>
    </mat-card>

    <!-- Dernières notes -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Dernières notes</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="stats.dernieresNotes || []" *ngIf="stats.dernieresNotes?.length > 0">
          <!-- Matière Column -->
          <ng-container matColumnDef="matiere">
            <th mat-header-cell *matHeaderCellDef> Matière </th>
            <td mat-cell *matCellDef="let note"> {{note.matiere?.nom}} </td>
          </ng-container>

          <!-- Note Column -->
          <ng-container matColumnDef="note">
            <th mat-header-cell *matHeaderCellDef> Note </th>
            <td mat-cell *matCellDef="let note"> {{note.valeur}} / 20 </td>
          </ng-container>

          <!-- Coefficient Column -->
          <ng-container matColumnDef="coefficient">
            <th mat-header-cell *matHeaderCellDef> Coefficient </th>
            <td mat-cell *matCellDef="let note"> {{note.coefficient}} </td>
          </ng-container>

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef> Date </th>
            <td mat-cell *matCellDef="let note"> {{note.date | date:'dd/MM/yyyy'}} </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['matiere', 'note', 'coefficient', 'date']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['matiere', 'note', 'coefficient', 'date'];"></tr>
        </table>

        <div *ngIf="!stats.dernieresNotes || stats.dernieresNotes.length === 0" class="empty-list">
          <p>Aucune note enregistrée.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>